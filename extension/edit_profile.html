<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Edit Profile</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .profile-edit {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            color: #0a66c2;
            border-bottom: 2px solid #0a66c2;
            padding-bottom: 10px;
        }

        .field-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #0a66c2;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .experience-entry {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            align-items: center;
        }

        .experience-entry input:first-child {
            flex: 2;
        }

        .experience-entry input:last-child {
            flex: 1;
        }

        button {
            background: #0a66c2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #094a8f;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-danger {
            background: #d32f2f;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .qa-entry {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .qa-entry:hover {
            border-color: #0a66c2;
        }

        .qa-entry .question-input {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 8px;
            background: transparent;
            border: 1px dashed transparent;
        }

        .qa-entry .question-input:focus {
            background: white;
            border: 1px dashed #0a66c2;
        }

        .qa-entry .answer-input {
            font-size: 13px;
            color: #555;
            resize: vertical;
            min-height: 40px;
        }

        .qa-entry .btn-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff5252;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0;
        }

        .qa-entry .btn-remove:hover {
            background: #d32f2f;
        }

        .qa-stats {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #1565c0;
        }

        .qa-empty {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        #questionCacheList {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .qa-search input {
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="profile-edit">
        <h2>üìù Edit Profile</h2>

        <div class="section">
            <h3>Basic Information</h3>
            <div class="field-group">
                <label>First Name</label>
                <input type="text" id="firstName" placeholder="John">
            </div>
            <div class="field-group">
                <label>Last Name</label>
                <input type="text" id="lastName" placeholder="Doe">
            </div>
            <div class="field-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="john@example.com">
            </div>
            <div class="field-group">
                <label>Phone</label>
                <input type="text" id="phone" placeholder="(555) 123-4567">
            </div>
        </div>

        <div class="section">
            <h3>Social Links</h3>
            <div class="field-group">
                <label>LinkedIn</label>
                <input type="text" id="linkedin" placeholder="linkedin.com/in/johndoe">
            </div>
            <div class="field-group">
                <label>GitHub</label>
                <input type="text" id="github" placeholder="github.com/johndoe">
            </div>
            <div class="field-group">
                <label>Website</label>
                <input type="text" id="website" placeholder="johndoe.com">
            </div>
        </div>

        <div class="section">
            <h3>Location & Work</h3>
            <div class="field-group">
                <label>City</label>
                <input type="text" id="city" placeholder="San Francisco">
            </div>
            <div class="field-group">
                <label>State</label>
                <input type="text" id="state" placeholder="CA">
            </div>
            <div class="field-group">
                <label>Country</label>
                <input type="text" id="country" placeholder="United States">
            </div>
            <div class="field-group">
                <label>Current Company</label>
                <input type="text" id="currentCompany" placeholder="Google">
            </div>
            <div class="field-group">
                <label>Years of Experience</label>
                <input type="number" id="yearsExperience" placeholder="5">
            </div>
        </div>

        <div class="section">
            <h3>Work Authorization</h3>
            <div class="field-group">
                <label>Work Authorization</label>
                <input type="text" id="workAuthorization" placeholder="US Citizen, Green Card, etc.">
            </div>
            <div class="field-group">
                <label>Sponsorship Required</label>
                <input type="text" id="sponsorship" placeholder="Yes or No">
            </div>
            <div class="field-group">
                <label>Willing to Relocate</label>
                <input type="text" id="willingToRelocate" placeholder="Yes or No">
            </div>
        </div>

        <div class="section">
            <h3>Technology Experience (Years)</h3>
            <div id="experienceList"></div>
            <button type="button" class="btn-secondary" id="addExperience">+ Add Technology</button>
        </div>

        <div class="section">
            <h3>üß† Question Cache (Learned Answers)</h3>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                These are answers the system has learned from previous applications. You can edit, add, or remove entries.
            </p>
            <div class="qa-search">
                <input type="text" id="qaSearch" placeholder="üîç Search questions..." style="margin-bottom: 15px;">
            </div>
            <div id="questionCacheList"></div>
            <button type="button" class="btn-secondary" id="addQuestion" style="margin-top: 10px;">+ Add Question/Answer</button>
        </div>

        <div class="btn-group">
            <button id="saveProfile">Save Profile</button>
            <button class="btn-secondary" id="cancel">Cancel</button>
        </div>
    </div>

    <script>
        // This will be populated by the extension
        let currentProfile = null;
        let profileId = null;

        function loadProfile(profile) {
            currentProfile = profile;
            profileId = profile.id;

            document.getElementById('firstName').value = profile.firstName || '';
            document.getElementById('lastName').value = profile.lastName || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('linkedin').value = profile.linkedin || '';
            document.getElementById('github').value = profile.github || '';
            document.getElementById('website').value = profile.website || '';
            document.getElementById('city').value = profile.city || '';
            document.getElementById('state').value = profile.state || '';
            document.getElementById('country').value = profile.country || '';
            document.getElementById('currentCompany').value = profile.currentCompany || '';
            document.getElementById('yearsExperience').value = profile.yearsExperience || '';
            document.getElementById('workAuthorization').value = profile.workAuthorization || '';
            document.getElementById('sponsorship').value = profile.sponsorship || '';
            document.getElementById('willingToRelocate').value = profile.willingToRelocate || '';

            // Load experience
            const expList = document.getElementById('experienceList');
            expList.innerHTML = '';
            if (profile.experience) {
                Object.entries(profile.experience).forEach(([tech, years]) => {
                    addExperienceField(tech, years);
                });
            }

            // Load questionCache
            renderQuestionCache(profile.questionCache || {});
        }

        function renderQuestionCache(cache, filter = '') {
            const list = document.getElementById('questionCacheList');
            const entries = Object.entries(cache);
            
            // Filter entries if search is active
            const filtered = filter 
                ? entries.filter(([q, a]) => 
                    q.toLowerCase().includes(filter.toLowerCase()) || 
                    a.toLowerCase().includes(filter.toLowerCase()))
                : entries;

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="qa-empty">
                        ${filter ? 'No matching questions found.' : 'No cached questions yet. They will be learned during applications.'}
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <div class="qa-stats">
                    üìä ${filtered.length} of ${entries.length} cached answers ${filter ? '(filtered)' : ''}
                </div>
            `;

            filtered.forEach(([question, answer], idx) => {
                const div = document.createElement('div');
                div.className = 'qa-entry';
                div.dataset.originalQuestion = question;
                div.innerHTML = `
                    <button type="button" class="btn-remove" onclick="removeQA(this)" title="Remove">√ó</button>
                    <div class="field-group" style="margin-bottom: 8px;">
                        <input type="text" class="question-input" value="${escapeHtml(question)}" placeholder="Question">
                    </div>
                    <div class="field-group" style="margin-bottom: 0;">
                        <textarea class="answer-input" placeholder="Answer">${escapeHtml(answer)}</textarea>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function removeQA(btn) {
            const entry = btn.closest('.qa-entry');
            if (confirm('Remove this question/answer?')) {
                entry.remove();
                updateQAStats();
            }
        }

        function updateQAStats() {
            const entries = document.querySelectorAll('.qa-entry');
            const stats = document.querySelector('.qa-stats');
            if (stats) {
                stats.textContent = `üìä ${entries.length} cached answers`;
            }
        }

        function addQuestionField(question = '', answer = '') {
            const list = document.getElementById('questionCacheList');
            
            // Remove empty message if present
            const empty = list.querySelector('.qa-empty');
            if (empty) empty.remove();
            
            // Add stats if not present
            if (!list.querySelector('.qa-stats')) {
                const stats = document.createElement('div');
                stats.className = 'qa-stats';
                stats.textContent = 'üìä 0 cached answers';
                list.prepend(stats);
            }

            const div = document.createElement('div');
            div.className = 'qa-entry';
            div.dataset.originalQuestion = '';
            div.innerHTML = `
                <button type="button" class="btn-remove" onclick="removeQA(this)" title="Remove">√ó</button>
                <div class="field-group" style="margin-bottom: 8px;">
                    <input type="text" class="question-input" value="${escapeHtml(question)}" placeholder="Enter question...">
                </div>
                <div class="field-group" style="margin-bottom: 0;">
                    <textarea class="answer-input" placeholder="Enter answer...">${escapeHtml(answer)}</textarea>
                </div>
            `;
            list.appendChild(div);
            updateQAStats();
            
            // Focus the new question input
            div.querySelector('.question-input').focus();
        }

        function addExperienceField(tech = '', years = '') {
            const div = document.createElement('div');
            div.className = 'experience-entry';
            div.innerHTML = `
                <input type="text" placeholder="Technology (e.g., JavaScript)" value="${tech}">
                <input type="number" placeholder="Years" value="${years}">
                <button type="button" class="btn-danger" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById('experienceList').appendChild(div);
        }

        document.getElementById('addExperience').onclick = () => addExperienceField();
        document.getElementById('addQuestion').onclick = () => addQuestionField();
        
        // Search functionality
        document.getElementById('qaSearch').addEventListener('input', (e) => {
            const filter = e.target.value;
            const cache = collectQuestionCache();
            renderQuestionCache(cache, filter);
        });

        function collectQuestionCache() {
            const questionCache = {};
            document.querySelectorAll('.qa-entry').forEach(entry => {
                const question = entry.querySelector('.question-input').value.trim();
                const answer = entry.querySelector('.answer-input').value.trim();
                if (question) {
                    questionCache[question] = answer;
                }
            });
            return questionCache;
        }

        document.getElementById('saveProfile').onclick = () => {
            const experience = {};
            document.querySelectorAll('.experience-entry').forEach(entry => {
                const tech = entry.children[0].value.trim();
                const years = parseInt(entry.children[1].value);
                if (tech && years) {
                    experience[tech] = years;
                }
            });

            // Collect questionCache
            const questionCache = collectQuestionCache();

            const updatedProfile = {
                ...currentProfile,
                id: profileId,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                linkedin: document.getElementById('linkedin').value,
                github: document.getElementById('github').value,
                website: document.getElementById('website').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                country: document.getElementById('country').value,
                currentCompany: document.getElementById('currentCompany').value,
                yearsExperience: parseInt(document.getElementById('yearsExperience').value) || 0,
                workAuthorization: document.getElementById('workAuthorization').value,
                sponsorship: document.getElementById('sponsorship').value,
                willingToRelocate: document.getElementById('willingToRelocate').value,
                experience: experience,
                questionCache: questionCache,
                profileName: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`.trim()
            };

            // Send back to extension
            chrome.runtime.sendMessage({
                type: 'UPDATE_PROFILE',
                payload: updatedProfile
            }, () => {
                window.close();
            });
        };

        document.getElementById('cancel').onclick = () => window.close();

        // Receive profile from extension
        chrome.runtime.onMessage.addListener((msg) => {
            if (msg.type === 'LOAD_PROFILE') {
                loadProfile(msg.payload);
            }
        });
    </script>
</body>

</html>